pipeline{

    agent {
        label "slave"
    }

    environment{
        AWS_ACCESS_KEY_ID = credentials("aws-access-key")
        AWS_SECRET_KEY_ID = credentials("aws-secret-key")
        ANSIBLE = "./deploy/playbooks"
    }

    stages{

        stage("Install Ansible"){
            steps{
                sh "yum install ansible -y"
            }
        }

        stage("Configuring Terraform and applying Terraform Scripts"){
            steps{
                dir("ANSIBLE"){
                    sh "ansible-playbook eks-config.yml"
                }
            }
        }

        stage("Deploying k8s application deployment file through Ansible"){
            steps{
                dir("ANSIBLE"){
                    sh "ansible-playbook k8s-deployment.yml"
                }
            }
        }

    }

    post{
        success{
            echo "Deployment Successful"
        }
        failure{
            echo "Deployment Failure"
        }
    }


}